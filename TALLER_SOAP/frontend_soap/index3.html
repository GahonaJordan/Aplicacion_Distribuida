<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Artículos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f4f6f8; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; color: white; margin: 2px; }
    .btn-update { background: #28a745; }
    .btn-delete { background: #dc3545; }
    .btn-search { background: #007bff; }
    .btn-list { background: #17a2b8; }
    .btn-refresh { background: #6c757d; }
    .low-stock { background: #fff3cd; color: #856404; font-weight: bold; }
    .message { margin-top: 10px; padding: 10px; border-radius: 8px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { display: none; text-align: center; padding: 10px; }
    .search-container { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .search-container input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 200px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestión de Artículos</h1>

    <div class="search-container">
      <input type="text" id="codigoBuscar" placeholder="Buscar artículo por código..." />
      <button class="btn btn-search" onclick="buscarArticuloSOAP()">Buscar por Código (SOAP)</button>
      <button class="btn btn-list" onclick="loadArticulosREST()">Listar Todos (REST)</button>
      <button class="btn btn-refresh" onclick="cargarTodo()">Recargar Todo</button>
    </div>

    <div id="loading" class="loading">
      <p>Cargando artículos...</p>
    </div>

    <div id="message"></div>

    <table id="tablaArticulos">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Precio Compra</th>
          <th>Precio Venta</th>
          <th>Stock</th>
          <th>Stock Mínimo</th>
          <th>Proveedor</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
  const REST_API = "http://localhost:8080/api/articulos";
  const SOAP_URL = "http://localhost:9091/ws";
  const SOAP_USER = 'admin';
  const SOAP_PASS = 'admin123';

    // Función auxiliar para mostrar/ocultar el indicador de carga
    function toggleLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // Carga todos los artículos (REST) - MÁS RÁPIDO Y SIMPLE
    async function loadArticulosREST() {
      toggleLoading(true);
      try {
        const res = await fetch(REST_API);
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`REST error ${res.status}: ${txt.slice(0,200)}`);
        }
        const data = await res.json();
        renderTabla(data);
        showMessage(`Se cargaron ${data.length} artículos mediante REST.`, "success");
      } catch (err) {
        showMessage("Error al cargar artículos: " + err.message, "error");
        console.error(err);
      } finally {
        toggleLoading(false);
      }
    }

    // Buscar artículo individual por SOAP - MÁS PRECISO PARA BÚSQUEDAS ESPECÍFICAS
    async function buscarArticuloSOAP() {
      const codigo = document.getElementById("codigoBuscar").value.trim();
      if (!codigo) {
        showMessage("Ingrese un código para buscar.", "error");
        return;
      }

      const soapEnvelope = `
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                          xmlns:art="http://www.example.com/soap/articulos">
          <soapenv:Header/>
          <soapenv:Body>
            <art:ConsultarArticuloRequest>
              <art:codigo>${codigo}</art:codigo>
            </art:ConsultarArticuloRequest>
          </soapenv:Body>
        </soapenv:Envelope>
      `;

      try {
        toggleLoading(true);
        const res = await fetch(SOAP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/xml",
            'Authorization': 'Basic ' + btoa(SOAP_USER + ':' + SOAP_PASS)
          },
          body: soapEnvelope
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(`SOAP error ${res.status}: ${t.slice(0,200)}`);
        }

        const text = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        // helper: busca el primer elemento por localName en cualquier namespace
        const getText = (doc, localName) => {
          const byNS = doc.getElementsByTagNameNS('*', localName);
          if (byNS && byNS.length > 0) return byNS[0].textContent;
          // fallback: buscar por cualquier tag y comparar localName
          const all = doc.getElementsByTagName('*');
          for (let i = 0; i < all.length; i++) {
            if ((all[i].localName || all[i].nodeName) === localName) return all[i].textContent;
          }
          return null;
        };

        const codigoResp = getText(xml, 'codigo');
        if (!codigoResp) {
          showMessage(`No existe el artículo con código ${codigo}.`, "error");
          return;
        }

        const art = {
          codigo: codigoResp,
          nombre: getText(xml, 'nombre'),
          categoria: getText(xml, 'categoria'),
          precioCompra: getText(xml, 'precioCompra'),
          precioVenta: getText(xml, 'precioVenta'),
          stock: getText(xml, 'stock'),
          stockMinimo: getText(xml, 'stockMinimo'),
          proveedor: getText(xml, 'proveedor')
        };
        renderTabla([art]);
        showMessage(`Artículo ${codigo} encontrado mediante SOAP.`, "success");
      } catch (err) {
        showMessage("Error al buscar artículo: " + err.message, "error");
        console.error(err);
      } finally {
        toggleLoading(false);
      }
    }

    // Función que combina ambos enfoques según necesidad
    async function cargarTodo() {
      // Para carga inicial, usar REST que es más rápido
      await loadArticulosREST();
    }

    // Actualizar artículo (REST) - MÁS EFICIENTE PARA ACTUALIZACIONES
    async function actualizarArticulo(codigo) {
      const nuevoStock = prompt("Ingrese el nuevo stock para el artículo " + codigo + ":");
      if (nuevoStock === null) return;

      try {
        const res = await fetch(`${REST_API}/${codigo}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ stock: parseInt(nuevoStock) })
        });

        if (res.ok) {
          showMessage("Artículo actualizado correctamente mediante REST.", "success");
          loadArticulosREST(); // Recargar lista con REST (más rápido)
        } else {
          showMessage("Error al actualizar el artículo.", "error");
        }
      } catch (err) {
        showMessage("Error al actualizar: " + err.message, "error");
      }
    }

    // Eliminar artículo (REST) - MÁS SIMPLE PARA ELIMINACIONES
    async function eliminarArticulo(codigo) {
      if (!confirm(`¿Seguro que desea eliminar el artículo ${codigo}?`)) return;

      try {
        const res = await fetch(`${REST_API}/${codigo}`, { method: "DELETE" });
        if (res.ok) {
          showMessage("Artículo eliminado correctamente mediante REST.", "success");
          loadArticulosREST(); // Recargar lista con REST
        } else {
          showMessage("Error al eliminar el artículo.", "error");
        }
      } catch (err) {
        showMessage("Error al eliminar: " + err.message, "error");
      }
    }

    // Renderizar tabla
    function renderTabla(articulos) {
      const tbody = document.querySelector("#tablaArticulos tbody");
      tbody.innerHTML = "";

      if (articulos.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" style="text-align: center;">No se encontraron artículos</td>`;
        tbody.appendChild(tr);
        return;
      }

      articulos.forEach(a => {
        const stockVal = parseInt(a.stock || '0');
        const minimoVal = parseInt(a.stockMinimo || '0');
        const lowStock = !isNaN(stockVal) && !isNaN(minimoVal) && stockVal < minimoVal;
        const tr = document.createElement("tr");
        const safeCodigo = String(a.codigo || '').replace(/'/g, "\\'");
        tr.innerHTML = `
          <td>${a.codigo || ''}</td>
          <td>${a.nombre || ''}</td>
          <td>${a.categoria || ''}</td>
          <td>${a.precioCompra || ''}</td>
          <td>${a.precioVenta || ''}</td>
          <td class="${lowStock ? 'low-stock' : ''}">${a.stock || ''}</td>
          <td>${a.stockMinimo || ''}</td>
          <td>${a.proveedor || ''}</td>
          <td>
            <button class="btn btn-update" onclick="actualizarArticulo('${safeCodigo}')">Actualizar</button>
            <button class="btn btn-delete" onclick="eliminarArticulo('${safeCodigo}')">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Mostrar mensaje visual
    function showMessage(msg, type) {
      const div = document.getElementById("message");
      div.innerHTML = `<div class="message ${type}">${msg}</div>`;
    }

    // Cargar al inicio usando REST (más rápido para lista completa)
    cargarTodo();
  </script>
</body>
</html>