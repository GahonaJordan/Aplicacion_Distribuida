<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Artículos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f4f6f8; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; color: white; margin: 2px; }
    .btn-update { background: #28a745; }
    .btn-delete { background: #dc3545; }
    .btn-search { background: #007bff; }
    .btn-list { background: #17a2b8; }
    .btn-refresh { background: #6c757d; }
    .btn-create { background: #ffc107; color: black; }
    .low-stock { background: #fff3cd; color: #856404; font-weight: bold; }
    .message { margin-top: 10px; padding: 10px; border-radius: 8px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { display: none; text-align: center; padding: 10px; }
    .search-container { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .search-container input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 200px; }
    .actions-container { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestión de Artículos</h1>

    <div class="actions-container">
      <button class="btn btn-create" onclick="mostrarFormularioCrear()">Crear Nuevo Artículo</button>
      <button class="btn btn-refresh" onclick="cargarTodo()">Recargar Todo</button>
    </div>

    <div class="search-container">
      <input type="text" id="codigoBuscar" placeholder="Buscar artículo por código..." />
      <button class="btn btn-search" onclick="buscarArticuloSOAP()">Buscar por Código (SOAP)</button>
      <button class="btn btn-list" onclick="loadArticulosREST()">Listar Todos (REST)</button>
    </div>

    <div id="loading" class="loading">
      <p>Cargando artículos...</p>
    </div>

    <div id="message"></div>

    <!-- Formulario para crear/editar artículo -->
    <div id="formularioArticulo" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
      <h3 id="tituloFormulario">Crear Nuevo Artículo</h3>
      <form id="articuloForm" onsubmit="guardarArticulo(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
          <div>
            <label>Código:</label>
            <input type="text" id="codigo" name="codigo" required style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Nombre:</label>
            <input type="text" id="nombre" name="nombre" required style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Categoría:</label>
            <input type="text" id="categoria" name="categoria" style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Proveedor:</label>
            <input type="text" id="proveedor" name="proveedor" style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Precio Compra:</label>
            <input type="number" id="precioCompra" name="precioCompra" step="0.01" required style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Precio Venta:</label>
            <input type="number" id="precioVenta" name="precioVenta" step="0.01" required style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Stock:</label>
            <input type="number" id="stock" name="stock" value="0" style="width: 100%; padding: 6px;">
          </div>
          <div>
            <label>Stock Mínimo:</label>
            <input type="number" id="stockMinimo" name="stockMinimo" value="0" style="width: 100%; padding: 6px;">
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-update">Guardar</button>
          <button type="button" class="btn btn-delete" onclick="ocultarFormulario()">Cancelar</button>
        </div>
      </form>
    </div>

    <table id="tablaArticulos">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Precio Compra</th>
          <th>Precio Venta</th>
          <th>Stock</th>
          <th>Stock Mínimo</th>
          <th>Proveedor</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
  const REST_API = "http://localhost:8080/api/articulos";
  const SOAP_URL = "http://localhost:9091/ws";
  const SOAP_USER = 'admin';
  const SOAP_PASS = 'admin123';

  let articuloEditando = null;

  // Función auxiliar para mostrar/ocultar el indicador de carga
  function toggleLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
  }

  // Carga todos los artículos (REST) - Usando tu endpoint @GetMapping
  async function loadArticulosREST() {
    toggleLoading(true);
    try {
      const res = await fetch(REST_API);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`REST error ${res.status}: ${txt.slice(0,200)}`);
      }
      const data = await res.json();
      renderTabla(data);
      showMessage(`Se cargaron ${data.length} artículos mediante REST.`, "success");
    } catch (err) {
      showMessage("Error al cargar artículos: " + err.message, "error");
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  }

  // Buscar artículo individual por SOAP
  async function buscarArticuloSOAP() {
    const codigo = document.getElementById("codigoBuscar").value.trim();
    if (!codigo) {
      showMessage("Ingrese un código para buscar.", "error");
      return;
    }

    const soapEnvelope = `
      <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                        xmlns:art="http://www.example.com/soap/articulos">
        <soapenv:Header/>
        <soapenv:Body>
          <art:ConsultarArticuloRequest>
            <art:codigo>${codigo}</art:codigo>
          </art:ConsultarArticuloRequest>
        </soapenv:Body>
      </soapenv:Envelope>
    `;

    try {
      toggleLoading(true);
      const res = await fetch(SOAP_URL, {
        method: "POST",
        headers: {
          "Content-Type": "text/xml",
          'Authorization': 'Basic ' + btoa(SOAP_USER + ':' + SOAP_PASS)
        },
        body: soapEnvelope
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`SOAP error ${res.status}: ${t.slice(0,200)}`);
      }

      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "text/xml");

      const getText = (doc, localName) => {
        const byNS = doc.getElementsByTagNameNS('*', localName);
        if (byNS && byNS.length > 0) return byNS[0].textContent;
        const all = doc.getElementsByTagName('*');
        for (let i = 0; i < all.length; i++) {
          if ((all[i].localName || all[i].nodeName) === localName) return all[i].textContent;
        }
        return null;
      };

      const codigoResp = getText(xml, 'codigo');
      if (!codigoResp) {
        showMessage(`No existe el artículo con código ${codigo}.`, "error");
        return;
      }

      const art = {
        codigo: codigoResp,
        nombre: getText(xml, 'nombre'),
        categoria: getText(xml, 'categoria'),
        precioCompra: getText(xml, 'precioCompra'),
        precioVenta: getText(xml, 'precioVenta'),
        stock: getText(xml, 'stock'),
        stockMinimo: getText(xml, 'stockMinimo'),
        proveedor: getText(xml, 'proveedor')
      };
      renderTabla([art]);
      showMessage(`Artículo ${codigo} encontrado mediante SOAP.`, "success");
    } catch (err) {
      showMessage("Error al buscar artículo: " + err.message, "error");
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  }

  // Crear nuevo artículo (REST)
  async function crearArticulo(articulo) {
    try {
      const res = await fetch(REST_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(articulo)
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || 'Error al crear artículo');
      }

      const data = await res.json();
      showMessage("Artículo creado correctamente.", "success");
      loadArticulosREST();
      return data;
    } catch (err) {
      showMessage("Error al crear artículo: " + err.message, "error");
      throw err;
    }
  }

  // Actualizar artículo (REST) - Usando tu endpoint @PutMapping
  async function actualizarArticulo(codigo, articulo) {
    try {
      const res = await fetch(`${REST_API}/${codigo}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(articulo)
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || 'Error al actualizar artículo');
      }

      const data = await res.json();
      showMessage("Artículo actualizado correctamente.", "success");
      loadArticulosREST();
      return data;
    } catch (err) {
      showMessage("Error al actualizar artículo: " + err.message, "error");
      throw err;
    }
  }

  // Eliminar artículo (REST) - Usando tu endpoint @DeleteMapping
  async function eliminarArticulo(codigo) {
    if (!confirm(`¿Seguro que desea eliminar el artículo ${codigo}?`)) return;

    try {
      const res = await fetch(`${REST_API}/${codigo}`, { 
        method: "DELETE" 
      });

      if (res.status === 204) {
        showMessage("Artículo eliminado correctamente.", "success");
        loadArticulosREST();
      } else if (res.status === 404) {
        showMessage("Artículo no encontrado.", "error");
      } else {
        const errorText = await res.text();
        throw new Error(errorText || 'Error al eliminar artículo');
      }
    } catch (err) {
      showMessage("Error al eliminar: " + err.message, "error");
    }
  }

  // Funciones del formulario
  function mostrarFormularioCrear() {
    articuloEditando = null;
    document.getElementById('tituloFormulario').textContent = 'Crear Nuevo Artículo';
    document.getElementById('articuloForm').reset();
    document.getElementById('formularioArticulo').style.display = 'block';
  }

  function mostrarFormularioEditar(articulo) {
    articuloEditando = articulo;
    document.getElementById('tituloFormulario').textContent = 'Editar Artículo';
    document.getElementById('codigo').value = articulo.codigo || '';
    document.getElementById('nombre').value = articulo.nombre || '';
    document.getElementById('categoria').value = articulo.categoria || '';
    document.getElementById('proveedor').value = articulo.proveedor || '';
    document.getElementById('precioCompra').value = articulo.precioCompra || '';
    document.getElementById('precioVenta').value = articulo.precioVenta || '';
    document.getElementById('stock').value = articulo.stock || 0;
    document.getElementById('stockMinimo').value = articulo.stockMinimo || 0;
    document.getElementById('formularioArticulo').style.display = 'block';
  }

  function ocultarFormulario() {
    document.getElementById('formularioArticulo').style.display = 'none';
    articuloEditando = null;
  }

  async function guardarArticulo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const articulo = {
      codigo: formData.get('codigo'),
      nombre: formData.get('nombre'),
      categoria: formData.get('categoria'),
      proveedor: formData.get('proveedor'),
      precioCompra: parseFloat(formData.get('precioCompra')),
      precioVenta: parseFloat(formData.get('precioVenta')),
      stock: parseInt(formData.get('stock')),
      stockMinimo: parseInt(formData.get('stockMinimo'))
    };

    try {
      if (articuloEditando) {
        await actualizarArticulo(articuloEditando.codigo, articulo);
      } else {
        await crearArticulo(articulo);
      }
      ocultarFormulario();
    } catch (err) {
      console.error('Error al guardar artículo:', err);
    }
  }

  // Función que combina ambos enfoques según necesidad
  async function cargarTodo() {
    await loadArticulosREST();
  }

  // Renderizar tabla
  function renderTabla(articulos) {
    const tbody = document.querySelector("#tablaArticulos tbody");
    tbody.innerHTML = "";

    if (articulos.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="9" style="text-align: center;">No se encontraron artículos</td>`;
      tbody.appendChild(tr);
      return;
    }

    articulos.forEach(a => {
      const stockVal = parseInt(a.stock || '0');
      const minimoVal = parseInt(a.stockMinimo || '0');
      const lowStock = !isNaN(stockVal) && !isNaN(minimoVal) && stockVal < minimoVal;
      const tr = document.createElement("tr");
      const safeCodigo = String(a.codigo || '').replace(/'/g, "\\'");
      tr.innerHTML = `
        <td>${a.codigo || ''}</td>
        <td>${a.nombre || ''}</td>
        <td>${a.categoria || ''}</td>
        <td>${a.precioCompra || ''}</td>
        <td>${a.precioVenta || ''}</td>
        <td class="${lowStock ? 'low-stock' : ''}">${a.stock || ''}</td>
        <td>${a.stockMinimo || ''}</td>
        <td>${a.proveedor || ''}</td>
        <td>
          <button class="btn btn-update" onclick="mostrarFormularioEditar(${JSON.stringify(a).replace(/"/g, '&quot;')})">Editar</button>
          <button class="btn btn-delete" onclick="eliminarArticulo('${safeCodigo}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Mostrar mensaje visual
  function showMessage(msg, type) {
    const div = document.getElementById("message");
    div.innerHTML = `<div class="message ${type}">${msg}</div>`;
    setTimeout(() => {
      div.innerHTML = '';
    }, 5000);
  }

  // Cargar al inicio usando REST
  cargarTodo();
  </script>
</body>
</html>